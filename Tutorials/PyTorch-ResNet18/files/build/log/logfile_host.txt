Copyright © 2023 Advanced Micro Devices, Inc. All rights reserved.
SPDX-License-Identifier: MIT

----------------------------------------------------------------------------------
[DB INFO STEP3A] VCoR TRAINING
----------------------------------------------------------------------------------

+ echo ' '

+ echo 'Running Training...'
Running Training...
+ echo ' '

+ DATA_DIR=./build/data/
+ WEIGHTS=./build/float
+ DATASET=vcor
+ GPU_ID=0
+ export PYTHONPATH=/workspace/tutorials/PyTorch-ResNet18/files:
+ PYTHONPATH=/workspace/tutorials/PyTorch-ResNet18/files:
+ CUDA_VISIBLE_DEVICES=0
+ python code/train.py --batch-size 512 --epochs 30 --backbone resnet18 --save-model --data_root ./build/data/vcor --save_dir=./build/float
train num: 7267
classes: ['beige', 'black', 'blue', 'brown', 'gold', 'green', 'grey', 'orange', 'pink', 'purple', 'red', 'silver', 'tan', 'white', 'yellow']
/opt/vitis_ai/conda/envs/vitis-ai-pytorch/lib/python3.7/site-packages/torchvision/models/_utils.py:209: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and will be removed in 0.15, please use 'weights' instead.
 f"The parameter '{pretrained_param}' is deprecated since 0.13 and will be removed in 0.15, "
/opt/vitis_ai/conda/envs/vitis-ai-pytorch/lib/python3.7/site-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and will be removed in 0.15. The current behavior is equivalent to passing `weights=None`.
 warnings.warn(msg)

Train Epoch: 1 [0/7267 (0%)]	Loss: 2.903230
Train Epoch: 1 [5120/7267 (71%)]	Loss: 1.854987

Test set: Average loss: 3.5867, Accuracy: 569/1550 (36.710%)

cur acc: 36.70967741935484
Train Epoch: 2 [0/7267 (0%)]	Loss: 1.173988
Train Epoch: 2 [5120/7267 (71%)]	Loss: 0.614306

Test set: Average loss: 1.1460, Accuracy: 951/1550 (61.355%)

cur acc: 61.354838709677416
Train Epoch: 3 [0/7267 (0%)]	Loss: 0.656010
Train Epoch: 3 [5120/7267 (71%)]	Loss: 0.607066

Test set: Average loss: 1.1593, Accuracy: 955/1550 (61.613%)

cur acc: 61.61290322580645
Train Epoch: 4 [0/7267 (0%)]	Loss: 0.501045
Train Epoch: 4 [5120/7267 (71%)]	Loss: 0.421625

Test set: Average loss: 0.7424, Accuracy: 1151/1550 (74.258%)

cur acc: 74.25806451612904
Train Epoch: 5 [0/7267 (0%)]	Loss: 0.466459
Train Epoch: 5 [5120/7267 (71%)]	Loss: 0.336045

Test set: Average loss: 0.7293, Accuracy: 1140/1550 (73.548%)

Train Epoch: 6 [0/7267 (0%)]	Loss: 0.368082
Train Epoch: 6 [5120/7267 (71%)]	Loss: 0.301407

Test set: Average loss: 0.4627, Accuracy: 1287/1550 (83.032%)

cur acc: 83.03225806451613
Train Epoch: 7 [0/7267 (0%)]	Loss: 0.160113
Train Epoch: 7 [5120/7267 (71%)]	Loss: 0.235304

Test set: Average loss: 0.6990, Accuracy: 1223/1550 (78.903%)

Train Epoch: 8 [0/7267 (0%)]	Loss: 0.214300
Train Epoch: 8 [5120/7267 (71%)]	Loss: 0.316569

Test set: Average loss: 0.4451, Accuracy: 1305/1550 (84.194%)

cur acc: 84.19354838709677
Train Epoch: 9 [0/7267 (0%)]	Loss: 0.133911
Train Epoch: 9 [5120/7267 (71%)]	Loss: 0.143832

Test set: Average loss: 0.3922, Accuracy: 1338/1550 (86.323%)

cur acc: 86.3225806451613
Train Epoch: 10 [0/7267 (0%)]	Loss: 0.091100
Train Epoch: 10 [5120/7267 (71%)]	Loss: 0.096759

Test set: Average loss: 0.4214, Accuracy: 1356/1550 (87.484%)

cur acc: 87.48387096774194
Train Epoch: 11 [0/7267 (0%)]	Loss: 0.066825
Train Epoch: 11 [5120/7267 (71%)]	Loss: 0.059478

Test set: Average loss: 0.3885, Accuracy: 1373/1550 (88.581%)

cur acc: 88.58064516129032
Train Epoch: 12 [0/7267 (0%)]	Loss: 0.048501
Train Epoch: 12 [5120/7267 (71%)]	Loss: 0.037695

Test set: Average loss: 0.3985, Accuracy: 1362/1550 (87.871%)

Train Epoch: 13 [0/7267 (0%)]	Loss: 0.028054
Train Epoch: 13 [5120/7267 (71%)]	Loss: 0.017095

Test set: Average loss: 0.4185, Accuracy: 1360/1550 (87.742%)

Train Epoch: 14 [0/7267 (0%)]	Loss: 0.025985
Train Epoch: 14 [5120/7267 (71%)]	Loss: 0.014563

Test set: Average loss: 0.4188, Accuracy: 1358/1550 (87.613%)

Train Epoch: 15 [0/7267 (0%)]	Loss: 0.019562
Train Epoch: 15 [5120/7267 (71%)]	Loss: 0.018889

Test set: Average loss: 0.4038, Accuracy: 1378/1550 (88.903%)

cur acc: 88.90322580645162
Train Epoch: 16 [0/7267 (0%)]	Loss: 0.014661
Train Epoch: 16 [5120/7267 (71%)]	Loss: 0.011182

Test set: Average loss: 0.3994, Accuracy: 1374/1550 (88.645%)

Train Epoch: 17 [0/7267 (0%)]	Loss: 0.012224
Train Epoch: 17 [5120/7267 (71%)]	Loss: 0.005061

Test set: Average loss: 0.4053, Accuracy: 1379/1550 (88.968%)

cur acc: 88.96774193548387
Train Epoch: 18 [0/7267 (0%)]	Loss: 0.003486
Train Epoch: 18 [5120/7267 (71%)]	Loss: 0.003476

Test set: Average loss: 0.4097, Accuracy: 1385/1550 (89.355%)

cur acc: 89.35483870967742
Train Epoch: 19 [0/7267 (0%)]	Loss: 0.008391
Train Epoch: 19 [5120/7267 (71%)]	Loss: 0.011351

Test set: Average loss: 0.4057, Accuracy: 1379/1550 (88.968%)

Train Epoch: 20 [0/7267 (0%)]	Loss: 0.003489
Train Epoch: 20 [5120/7267 (71%)]	Loss: 0.007715

Test set: Average loss: 0.4127, Accuracy: 1376/1550 (88.774%)

Train Epoch: 21 [0/7267 (0%)]	Loss: 0.008488
Train Epoch: 21 [5120/7267 (71%)]	Loss: 0.004730

Test set: Average loss: 0.4141, Accuracy: 1380/1550 (89.032%)

Train Epoch: 22 [0/7267 (0%)]	Loss: 0.007366
Train Epoch: 22 [5120/7267 (71%)]	Loss: 0.011764

Test set: Average loss: 0.4108, Accuracy: 1377/1550 (88.839%)

Train Epoch: 23 [0/7267 (0%)]	Loss: 0.002189
Train Epoch: 23 [5120/7267 (71%)]	Loss: 0.002978

Test set: Average loss: 0.4212, Accuracy: 1378/1550 (88.903%)

Train Epoch: 24 [0/7267 (0%)]	Loss: 0.002260
Train Epoch: 24 [5120/7267 (71%)]	Loss: 0.010129

Test set: Average loss: 0.4245, Accuracy: 1378/1550 (88.903%)

Train Epoch: 25 [0/7267 (0%)]	Loss: 0.001637
Train Epoch: 25 [5120/7267 (71%)]	Loss: 0.007612

Test set: Average loss: 0.4290, Accuracy: 1381/1550 (89.097%)

Train Epoch: 26 [0/7267 (0%)]	Loss: 0.002352
Train Epoch: 26 [5120/7267 (71%)]	Loss: 0.004123

Test set: Average loss: 0.4348, Accuracy: 1381/1550 (89.097%)

Train Epoch: 27 [0/7267 (0%)]	Loss: 0.002284
Train Epoch: 27 [5120/7267 (71%)]	Loss: 0.001695

Test set: Average loss: 0.4325, Accuracy: 1383/1550 (89.226%)

Train Epoch: 28 [0/7267 (0%)]	Loss: 0.001360
Train Epoch: 28 [5120/7267 (71%)]	Loss: 0.002438

Test set: Average loss: 0.4278, Accuracy: 1382/1550 (89.161%)

Train Epoch: 29 [0/7267 (0%)]	Loss: 0.004103
Train Epoch: 29 [5120/7267 (71%)]	Loss: 0.006058

Test set: Average loss: 0.4320, Accuracy: 1380/1550 (89.032%)

----------------------------------------------------------------------------------
[DB INFO STEP3B] VCoR TESTING
----------------------------------------------------------------------------------

+ DATA_DIR=./build/data
+ WEIGHTS=./build/float
+ DATASET=vcor
+ GPU_ID=0
+ export PYTHONPATH=/workspace/tutorials/PyTorch-ResNet18/files:
+ PYTHONPATH=/workspace/tutorials/PyTorch-ResNet18/files:
+ echo ' '

+ echo 'Conducting testing with floating point CNN'
Conducting testing with floating point CNN
+ echo ' '

+ CUDA_VISIBLE_DEVICES=0
+ python code/test.py --backbone resnet18 --resume ./build/float/color_last_resnet18.pt --data_root ./build/data/vcor

[VAIQ_NOTE]: Loading NNDCT kernels...
test num: 1550
classes: ['beige', 'black', 'blue', 'brown', 'gold', 'green', 'grey', 'orange', 'pink', 'purple', 'red', 'silver', 'tan', 'white', 'yellow']

Test set: Average loss: 0.4320, Accuracy: 1380/1550 (89.032%)


----------------------------------------------------------------------------------
[DB INFO STEP4] QUANTIZE VCoR TRAINED CNN
----------------------------------------------------------------------------------
+ echo 'Activate environment...'
Activate environment...
+ DATA_DIR=./build/data/
+ WEIGHTS=./build/float
+ DATASET=vcor
+ GPU_ID=0
+ QUANT_DIR=quantized
+ export PYTHONPATH=/workspace/tutorials/PyTorch-ResNet18/files:
+ PYTHONPATH=/workspace/tutorials/PyTorch-ResNet18/files:
+ echo 'Conducting Quantization'
Conducting Quantization
+ CUDA_VISIBLE_DEVICES=0
+ python code/test.py --backbone resnet18 --resume ./build/float/color_last_resnet18.pt --data_root ./build/data//vcor --quant_mode calib --quant_dir=quantized

[VAIQ_NOTE]: Loading NNDCT kernels...
test num: 1550
classes: ['beige', 'black', 'blue', 'brown', 'gold', 'green', 'grey', 'orange', 'pink', 'purple', 'red', 'silver', 'tan', 'white', 'yellow']

[VAIQ_NOTE]: OS and CPU information:
              system --- Linux
                node --- Prec5820Tow
             release --- 4.15.0-209-generic
             version --- #220-Ubuntu SMP Tue Mar 21 17:52:18 UTC 2023
             machine --- x86_64
           processor --- x86_64

[VAIQ_NOTE]: Tools version information:
                 GCC --- GCC 9.4.0
              python --- 3.7.12
             pytorch --- 1.12.1
       vai_q_pytorch --- 3.0.0+a44284e+torch1.12.1

[VAIQ_NOTE]: GPU information:
         device name --- Quadro P6000
    device available --- True
        device count --- 1
      current device --- 0

[VAIQ_NOTE]: Quant config file is empty, use default quant configuration

[VAIQ_NOTE]: Quantization calibration process start up...

[VAIQ_NOTE]: =>Quant Module is in 'cuda'.

[VAIQ_NOTE]: =>Parsing ResNet...

[VAIQ_NOTE]: Start to trace and freeze model...

[VAIQ_NOTE]: The input model ResNet is torch.nn.Module.

[VAIQ_NOTE]: Finish tracing.

[VAIQ_NOTE]: Processing ops...
██████████████████████████████████████████████████| 74/74 [00:00<00:00, 1672.54it/s, OpInfo: name = return_0, type = Return]

[VAIQ_NOTE]: =>Doing weights equalization...

[VAIQ_NOTE]: =>Quantizable module is generated.(quantized/ResNet.py)

[VAIQ_NOTE]: =>Get module with quantization.

Test set: Average loss: 0.4239, Accuracy: 1377/1550 (88.839%)


[VAIQ_NOTE]: =>Exporting quant config.(quantized/quant_info.json)
+ CUDA_VISIBLE_DEVICES=0
+ python code/test.py --backbone resnet18 --resume ./build/float/color_last_resnet18.pt --data_root ./build/data//vcor --quant_mode test --quant_dir=quantized

[VAIQ_NOTE]: Loading NNDCT kernels...
test num: 1550
classes: ['beige', 'black', 'blue', 'brown', 'gold', 'green', 'grey', 'orange', 'pink', 'purple', 'red', 'silver', 'tan', 'white', 'yellow']

[VAIQ_NOTE]: OS and CPU information:
              system --- Linux
                node --- Prec5820Tow
             release --- 4.15.0-209-generic
             version --- #220-Ubuntu SMP Tue Mar 21 17:52:18 UTC 2023
             machine --- x86_64
           processor --- x86_64

[VAIQ_NOTE]: Tools version information:
                 GCC --- GCC 9.4.0
              python --- 3.7.12
             pytorch --- 1.12.1
       vai_q_pytorch --- 3.0.0+a44284e+torch1.12.1

[VAIQ_NOTE]: GPU information:
         device name --- Quadro P6000
    device available --- True
        device count --- 1
      current device --- 0

[VAIQ_NOTE]: Quant config file is empty, use default quant configuration

[VAIQ_NOTE]: Quantization test process start up...

[VAIQ_NOTE]: =>Quant Module is in 'cuda'.

[VAIQ_NOTE]: =>Parsing ResNet...

[VAIQ_NOTE]: Start to trace and freeze model...

[VAIQ_NOTE]: The input model ResNet is torch.nn.Module.

[VAIQ_NOTE]: Finish tracing.

[VAIQ_NOTE]: Processing ops...
██████████████████████████████████████████████████| 74/74 [00:00<00:00, 1739.80it/s, OpInfo: name = return_0, type = Return]

[VAIQ_NOTE]: =>Doing weights equalization...

[VAIQ_NOTE]: =>Quantizable module is generated.(quantized/ResNet.py)

[VAIQ_NOTE]: =>Get module with quantization.

Test set: Average loss: 0.4234, Accuracy: 1376/1550 (88.774%)

+ CUDA_VISIBLE_DEVICES=0
+ python code/test.py --backbone resnet18 --resume ./build/float/color_last_resnet18.pt --data_root ./build/data//vcor --quant_mode test --quant_dir=quantized --deploy --device=cpu

[VAIQ_NOTE]: Loading NNDCT kernels...
test num: 1550
classes: ['beige', 'black', 'blue', 'brown', 'gold', 'green', 'grey', 'orange', 'pink', 'purple', 'red', 'silver', 'tan', 'white', 'yellow']

[VAIQ_NOTE]: OS and CPU information:
              system --- Linux
                node --- Prec5820Tow
             release --- 4.15.0-209-generic
             version --- #220-Ubuntu SMP Tue Mar 21 17:52:18 UTC 2023
             machine --- x86_64
           processor --- x86_64

[VAIQ_NOTE]: Tools version information:
                 GCC --- GCC 9.4.0
              python --- 3.7.12
             pytorch --- 1.12.1
       vai_q_pytorch --- 3.0.0+a44284e+torch1.12.1

[VAIQ_NOTE]: Quant config file is empty, use default quant configuration

[VAIQ_NOTE]: Quantization test process start up...

[VAIQ_NOTE]: =>Quant Module is in 'cpu'.

[VAIQ_NOTE]: =>Parsing ResNet...

[VAIQ_NOTE]: Start to trace and freeze model...

[VAIQ_NOTE]: The input model ResNet is torch.nn.Module.

[VAIQ_NOTE]: Finish tracing.

[VAIQ_NOTE]: Processing ops...
██████████████████████████████████████████████████| 74/74 [00:00<00:00, 1718.12it/s, OpInfo: name = return_0, type = Return]

[VAIQ_NOTE]: =>Doing weights equalization...

[VAIQ_NOTE]: =>Quantizable module is generated.(quantized/ResNet.py)

[VAIQ_NOTE]: =>Get module with quantization.

[VAIQ_NOTE]: =>Converting to xmodel ...

[VAIQ_WARN]: ResNet::3225 is not tensor.

[VAIQ_NOTE]: =>Dumping 'ResNet_0'' checking data...

[VAIQ_NOTE]: =>Finsh dumping data.(quantized/deploy_check_data_int/ResNet_0)

[VAIQ_NOTE]: =>Successfully convert 'ResNet_0' to xmodel.(quantized/ResNet_0_int.xmodel)
/opt/vitis_ai/conda/envs/vitis-ai-pytorch/lib/python3.7/site-packages/pytorch_nndct/nn/modules/prim_ops.py:116: TracerWarning: Converting a tensor to a Python boolean might cause the trace to be incorrect. We can't record the data flow of Python values, so this value will be treated as a constant in the future. This means that the trace might not generalize to other inputs!
 if not (list(self.node.out_tensors[0].shape[1:]) == list(input.size())[1:]):
/opt/vitis_ai/conda/envs/vitis-ai-pytorch/lib/python3.7/site-packages/pytorch_nndct/quantization/torchquantizer.py:53: TracerWarning: Converting a tensor to a Python boolean might cause the trace to be incorrect. We can't record the data flow of Python values, so this value will be treated as a constant in the future. This means that the trace might not generalize to other inputs!
 if inf.sum() > 0 or nan.sum() > 0:
/opt/vitis_ai/conda/envs/vitis-ai-pytorch/lib/python3.7/site-packages/pytorch_nndct/nn/modules/fix_ops.py:68: TracerWarning: Converting a tensor to a Python boolean might cause the trace to be incorrect. We can't record the data flow of Python values, so this value will be treated as a constant in the future. This means that the trace might not generalize to other inputs!
 tensor.storage().size() != tensor.numel()):

[VAIQ_NOTE]: ResNet_int.pt is generated.(quantized/ResNet_int.pt)

[VAIQ_NOTE]: ResNet_int.onnx is generated.(quantized/ResNet_int.onnx)

----------------------------------------------------------------------------------
[DB INFO STEP5] COMPILE VCoR QUANTIZED CNN
----------------------------------------------------------------------------------

----------------------------------------------------------------------------------
[DB INFO STEP5] COMPILE VCoR QUANTIZED CNN
----------------------------------------------------------------------------------

-----------------------------------------
COMPILING MODEL FOR ZCU102..
-----------------------------------------
[UNILOG][INFO] Compile mode: dpu
[UNILOG][INFO] Debug mode: null
[UNILOG][INFO] Target architecture: DPUCZDX8G_ISA1_B4096
[UNILOG][INFO] Graph name: ResNet_0, with op num: 171
[UNILOG][INFO] Begin to compile...
[UNILOG][INFO] Total device subgraph number 3, DPU subgraph number 1
[UNILOG][INFO] Compile done.
[UNILOG][INFO] The meta json is saved to "/workspace/tutorials/PyTorch-ResNet18/files/./build/compiled_zcu102/meta.json"
[UNILOG][INFO] The compiled xmodel is saved to "/workspace/tutorials/PyTorch-ResNet18/files/./build/compiled_zcu102/zcu102_ResNet_0_int.xmodel.xmodel"
[UNILOG][INFO] The compiled xmodel's md5sum is d40aab050d23171387f22d807a177720, and has been saved to "/workspace/tutorials/PyTorch-ResNet18/files/./build/compiled_zcu102/md5sum.txt"
**************************************************
* VITIS_AI Compilation - Xilinx Inc.
**************************************************
-----------------------------------------
MODEL COMPILED
-----------------------------------------
-----------------------------------------
COMPILING MODEL FOR VCK190..
-----------------------------------------
[UNILOG][INFO] Compile mode: dpu
[UNILOG][INFO] Debug mode: null
[UNILOG][INFO] Target architecture: DPUCVDX8G_ISA3_C32B6
[UNILOG][INFO] Graph name: ResNet_0, with op num: 171
[UNILOG][INFO] Begin to compile...
[UNILOG][INFO] Total device subgraph number 3, DPU subgraph number 1
[UNILOG][INFO] Compile done.
[UNILOG][INFO] The meta json is saved to "/workspace/tutorials/PyTorch-ResNet18/files/./build/compiled_vck190/meta.json"
[UNILOG][INFO] The compiled xmodel is saved to "/workspace/tutorials/PyTorch-ResNet18/files/./build/compiled_vck190/vck190_ResNet_0_int.xmodel.xmodel"
[UNILOG][INFO] The compiled xmodel's md5sum is df3f607e0b632e90d4c8eafdd174bef8, and has been saved to "/workspace/tutorials/PyTorch-ResNet18/files/./build/compiled_vck190/md5sum.txt"
**************************************************
* VITIS_AI Compilation - Xilinx Inc.
**************************************************
-----------------------------------------
MODEL COMPILED
-----------------------------------------
-----------------------------------------
COMPILING MODEL FOR VEK280
-----------------------------------------
[UNILOG][INFO] Compile mode: dpu
[UNILOG][INFO] Debug mode: null
[UNILOG][INFO] Target architecture: DPUCV2DX8G_ISA0_C16M4B13
[UNILOG][INFO] Graph name: ResNet_0, with op num: 171
[UNILOG][INFO] Begin to compile...
[UNILOG][INFO] Total device subgraph number 3, DPU subgraph number 1
[UNILOG][INFO] Compile done.
[UNILOG][INFO] The meta json is saved to "/workspace/tutorials/PyTorch-ResNet18/files/./build/compiled_vek280/meta.json"
[UNILOG][INFO] The compiled xmodel is saved to "/workspace/tutorials/PyTorch-ResNet18/files/./build/compiled_vek280/vek280_ResNet_0_int.xmodel.xmodel"
[UNILOG][INFO] The compiled xmodel's md5sum is b6a68506e3fdfed2514f9860806ca84f, and has been saved to "/workspace/tutorials/PyTorch-ResNet18/files/./build/compiled_vek280/md5sum.txt"
**************************************************
* VITIS_AI Compilation - Xilinx Inc.
**************************************************
-----------------------------------------
MODEL COMPILED
-----------------------------------------
-----------------------------------------
COMPILING MODEL FOR VCK5000
-----------------------------------------
[UNILOG][INFO] Compile mode: dpu
[UNILOG][INFO] Debug mode: null
[UNILOG][INFO] Target architecture: DPUCVDX8H_ISA1_F2W4_4PE
[UNILOG][INFO] Graph name: ResNet_0, with op num: 171
[UNILOG][INFO] Begin to compile...
[UNILOG][INFO] Total device subgraph number 3, DPU subgraph number 1
[UNILOG][INFO] Compile done.
[UNILOG][INFO] The meta json is saved to "/workspace/tutorials/PyTorch-ResNet18/files/./build/compiled_vck5000/meta.json"
[UNILOG][INFO] The compiled xmodel is saved to "/workspace/tutorials/PyTorch-ResNet18/files/./build/compiled_vck5000/vck5000_ResNet_0_int.xmodel.xmodel"
[UNILOG][INFO] The compiled xmodel's md5sum is 6af0cd6a9175084eb9ad1817c1dedd72, and has been saved to "/workspace/tutorials/PyTorch-ResNet18/files/./build/compiled_vck5000/md5sum.txt"
**************************************************
* VITIS_AI Compilation - Xilinx Inc.
**************************************************
-----------------------------------------
MODEL COMPILED
-----------------------------------------


[1]+  Done                    sudo chown -R vitis-ai-user /opt/vitis_ai/conda  (wd: /workspace)
(wd now: /workspace/tutorials/PyTorch-ResNet18/files)
(vitis-ai-pytorch) vitis-ai-user@Prec5820Tow:/workspace/tutorials/PyTorch-ResNet18/files$
